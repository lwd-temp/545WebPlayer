<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>545在线-播放</title>
    <meta name="description" content="545在线，电子雷峰塔，随时补充塔能量！笙歌牌播放器，采用PWA技术，支持智能缓存本地播放，可完全断网使用，由琴梨梨驱动" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <link rel="canonical" href="https://545.qinlili.bid/" />
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#FADCBB">
    <link rel="icon" href="./icon_mono.png">
    <link rel="apple-touch-icon" href="./icon.png">
    <meta name="apple-mobile-web-app-title" content="545在线">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="referrer" content="no-referrer" />
    <link rel="preconnect" href="https://i0.hdslb.com">
    <link rel="preconnect" href="https://bj.bcebos.com">
    <script>
        document.title = "载入播放器中...";
    </script>
    <link crossorigin="anonymous"
        integrity="sha512-tH5CEoO7QorGJK5RZrcKozo5xe0qC0UgOhjkIoqXNVe9ApFAjJRbVFzDfVvdRUSOJ5g2Pw9VzzOBguouzhLoIQ=="
        href="https://lib.baomitu.com/material-components-web/6.0.0/material-components-web.min.css" rel="stylesheet">
    <script crossorigin="anonymous"
        integrity="sha512-5zCl3JhN4Fqq6+irTX1v8J+77hwL54zTbrdl2Dl8YHe+KGcuV14C01u/uWFrSg+kZgOfGMneoUySVHqEgdRaPQ=="
        src="https://lib.baomitu.com/material-components-web/6.0.0/material-components-web.min.js"></script>
    <link crossorigin="anonymous"
        integrity="sha512-y9glprRcVESvYY3suAqBUYXx0ySbQNvbzzgvLy9F2o38Y7XCNeq/No2gnHjV3+Rjyq5ijoPZRMXotpdw6jcG4g=="
        href="https://lib.baomitu.com/material-design-icons/3.0.2/iconfont/material-icons.min.css" rel="stylesheet">
    <style>
        @keyframes leftin {
            from {
                margin-left: -100%;
            }

            to {
                margin-left: 0;
            }
        }

        @keyframes rightin {
            from {
                margin-left: 100%;
            }

            to {
                margin-left: 0;
            }
        }

        @keyframes bottomup {
            from {
                bottom: -100%;
            }

            to {
                bottom: 0;
            }
        }

        @keyframes bottomdown {
            from {
                bottom: 0;
            }

            to {
                bottom: -100%;
            }
        }
    </style>
    <style>
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-panel {
            background-color: rgba(256, 256, 256, 1.0);
            border-radius: 0px;
        }

        ::-webkit-scrollbar {
            height: 12px;
            width: 8px;
            background: transparent;
            z-index: 12;
            overflow: visible;
        }

        ::-webkit-scrollbar-thumb {
            width: 10px;
            background-color: #FADCBB;
            z-index: 12;
            border: 3px solid rgba(0, 0, 0, 0);
            background-clip: padding-box;
            transition: background-color .32s ease-in-out;
            margin: 4px;
            min-height: 32px;
            min-width: 32px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #FADCBB;
        }

        ::-webkit-scrollbar-corner {
            background: #202020;
        }

        *:focus {
            outline: none;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            scrollbar-width: thin;
            scrollbar-color: #FADCBB transparent;
            --mdc-theme-primary: #DCAC89;
            --mdc-theme-secondary: #FADCBB;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-user-select: none;
            user-select: none;
        }

        html,
        body {
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #playPanel {
            animation: bottomup 0.3s;
            z-index: 999;
            position: fixed;
            height: auto;
            min-height: 32px;
            width: auto;
            left: 0px;
            right: 0px;
            bottom: 0px;
            padding: 2px;
            background-color: white;
            box-shadow: 0px -2px 2px 1px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        #listContainer {
            overflow: hidden;
            height: 100vh;
        }

        #audioList,
        #playList {
            width: 100vw;
            text-align: left;
            overflow-y: auto;
            overflow-y: overlay;
            height: calc(100vh - 112px);
            margin-bottom: 64px;
            transition: width 0.2s ease-in;
        }

        #playList {
            animation: leftin 0.2s;
        }

        #audioList {
            animation: rightin 0.2s;
        }

        #tabBar {
            z-index: 999;
            position: fixed;
            height: auto;
            width: auto;
            left: 0px;
            right: 0px;
            top: 0px;
        }

        #empty {
            display: none;
            margin: auto;
            padding-top: 32px;
            height: auto;
            text-align: center;
        }

        .controls {
            justify-content: space-between;
            display: flex;
            flex-direction: row;
        }

        #status {
            display: flex;
            flex-direction: row;
            height: 32px;
            padding-left: 4px;
            max-width: calc(100vw - 100px);
        }

        #tips,
        .tips32 {
            margin: auto;
            font-size: 1.1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #loading {
            margin: 4px;
        }

        .buttons {
            display: flex;
            flex-direction: row;
        }

        .topBtn {
            border-radius: 2px;
            height: 24px;
            margin: 4px;
            width: 24px;
            transition: background-color 0.2s, transform 0.3s ease-in-out;
        }

        .topBtn:hover {
            transform: scale(1.1, 1.1);
            background-color: #cccccc;
        }

        .topBtn:active {
            background-color: #999999
        }

        .topBtn.active {
            background-color: #FADCBB
        }

        #padding {
            height: 48px;
        }

        #floatMenuContainer {
            transition: opacity 0.2s ease-in;
            opacity: 0;
            display: none;
            z-index: 9999;
            top: 0px;
            bottom: 0px;
            left: 0px;
            right: 0px;
            height: auto;
            width: auto;
            position: fixed;
            background-color: rgba(0, 0, 0, 0.15);
        }

        #floatMenu {
            overflow-y: auto;
            overflow-y: overlay;
            width: calc(100% - 20vw);
            height: -moz-fit-content;
            height: fit-content;
            max-height: calc(100% - 20vh);
            border-radius: 5px;
            backdrop-filter: blur(3px) brightness(100%);
            background-color: rgba(255, 255, 255, 0.75);
            margin-top: 10vh;
            margin-bottom: 10vh;
            margin-left: 10vw;
            margin-right: 10vw;
        }

        .mdc-list {
            padding: 0 0 !important;
        }

        @media (min-width: 700px) {
            #listContainer {
                display: flex !important;
                flex-direction: row-reverse !important;
            }

            #padding {
                height: 0px;
            }

            #audioList,
            #playList {
                height: calc(100vh - 64px);
                display: block !important;
                width: 50vw;
            }

            #tabBar {
                display: none;
            }
        }
    </style>
</head>

<body style="text-align: center">
    <div class="mdc-tab-bar" id="tabBar" role="tablist">
        <div class="mdc-tab-scroller">
            <div class="mdc-tab-scroller__scroll-area">
                <div class="mdc-tab-scroller__scroll-content">
                    <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0"
                        onclick="switchPlaylist();">
                        <span class="mdc-tab__content">
                            <span class="mdc-tab__text-label">播放列表</span>
                        </span>
                        <span class="mdc-tab-indicator mdc-tab-indicator--active">
                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                        </span>
                        <span class="mdc-tab__ripple"></span>
                    </button>
                    <button class="mdc-tab mdc-tab" role="tab" aria-selected="false" tabindex="-1"
                        onclick="switchAudioList();">
                        <span class="mdc-tab__content">
                            <span class="mdc-tab__text-label">全部歌单</span>
                        </span>
                        <span class="mdc-tab-indicator mdc-tab-indicator">
                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                        </span>
                        <span class="mdc-tab__ripple"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="playPanel">
        <div id="controls" class="controls">
            <div id="status">
                <img src="./img/loading.svg" id="loading">
                <p id="tips">正在加载播放器</p>
            </div>
            <div id="buttons" class="buttons">
                <img class="topBtn" id="shuffleBtn" onclick="switchShuffle();" alt="随机播放" src="./img/shuffle.svg">
                <img class="topBtn" id="repeatBtn" onclick="switchRepeat();" alt="循环播放" src="./img/repeat.svg">
                <img class="topBtn" id="settingBtn" onclick="functionMenu()" alt="菜单" src="./img/menu.svg">
            </div>
        </div>
        <audio controls autoplay id="player" style="width: 100%;height:32px;"></audio>
        <div id="backupControls" class="controls" style="display:none;">
            <div id="backupButtons" class="buttons">
                <img class="topBtn" id="playBtn" loading="lazy" onclick="switchPlay();" alt="播放" src="./img/play.svg">
                <img class="topBtn" id="nextBtn" loading="lazy"
                    onclick="player.dispatchEvent(new CustomEvent('ended'));" alt="下一曲" src="./img/next.svg">
            </div>
        </div>
    </div>
    <div id="padding"></div>
    <div id="listContainer">
        <div id="audioList" style="display:none;">
            <ul id="audioFolderModule" class="mdc-list mdc-list--two-line mdc-list--avatar-list">
            </ul>
            <ul id="audioFilesModule" style="display:none;" class="mdc-list mdc-list--two-line mdc-list--avatar-list">
            </ul>
        </div>
        <div id="playList">
            <div id="empty">
                <img src="./img/bai.png">
                <H2>播放列表空了,所以摆了</H2>
                <H3>去全部歌单里添加一些吧</H3>
            </div>
            <ul id="audioListModule" class="mdc-list mdc-list--two-line mdc-list--avatar-list">
            </ul>
        </div>
    </div>
    <div id="floatMenuContainer">
        <div id="floatMenu">
            <ul class="mdc-list" id="menuList">

            </ul>
        </div>
    </div>
    <script>
        const sleep = delay => new Promise((resolve) => setTimeout(resolve, delay))
        window.MDCTabBar = mdc.tabBar.MDCTabBar;
        window.MDCList = mdc.list.MDCList;
        window.MDCRipple = mdc.ripple.MDCRipple;
        const tabBar = new MDCTabBar(document.querySelector('.mdc-tab-bar'));
        const audioList = document.getElementById("audioList");
        const playList = document.getElementById("playList");
        const switchAudioList = () => {
            audioList.style.display = "block"
            playList.style.display = "none"
        }
        const switchPlaylist = () => {
            audioList.style.display = "none"
            playList.style.display = "block"
        }
        const random = (min, max) => {
            return Math.round(Math.random() * (max - min)) + min;
        }
        const dlFile = (link, name) => {
            let eleLink = document.createElement('a');
            eleLink.download = name;
            eleLink.style.display = 'none';
            eleLink.href = link;
            document.body.appendChild(eleLink);
            eleLink.click();
            document.body.removeChild(eleLink);
        }
        const bottomdown = () => {
            document.getElementById("playPanel").style.animation = "bottomdown 0.15s";
        }
        const loadScriptAsync = link => {
            return new Promise(resolve => {
                let script = document.createElement("script");
                script.src = link;
                script.onload = resolve;
                document.body.appendChild(script);
            });
        }
    </script>
    <script>
        //日后实现CDN切换
        const cdn = "yuketang";
        window.repeatSwitch = localStorage.repeat ? JSON.parse(localStorage.repeat) : false;
        window.shuffleSwitch = localStorage.shuffle ? JSON.parse(localStorage.shuffle) : false;
        window.codecBoost = localStorage.codecBoost ? JSON.parse(localStorage.codecBoost) : false;
        window.wasmPlayer = localStorage.wasmPlayer ? JSON.parse(localStorage.wasmPlayer) : false;
        window.fileShare = localStorage.fileShare ? JSON.parse(localStorage.fileShare) : false;
        if (repeatSwitch) {
            document.getElementById("repeatBtn").className = "topBtn active";
        };
        if (shuffleSwitch) {
            document.getElementById("shuffleBtn").className = "topBtn active";
        };
        const switchRepeat = () => {
            window.repeatSwitch = repeatSwitch ? false : true;
            localStorage.repeat = window.repeatSwitch;
            document.getElementById("repeatBtn").className = window.repeatSwitch ? "topBtn active" : "topBtn";
        };
        const switchShuffle = () => {
            window.shuffleSwitch = shuffleSwitch ? false : true;
            localStorage.shuffle = window.shuffleSwitch;
            document.getElementById("shuffleBtn").className = window.shuffleSwitch ? "topBtn active" : "topBtn";
        };
        const switchPlay = () => {
            if (window.wasmPlayer) {
                document.getElementById("playBtn").className = document.querySelector("#player").paused ? "topBtn active" : "topBtn";
                document.querySelector("#player").paused ? document.querySelector("#player").play() : document.querySelector("#player").pause()
            };
            if (window.codecBoost) {
                document.getElementById("playBtn").className = (audioCtx.state == "running") ? "topBtn" : "topBtn active";
                (audioCtx.state == "running") ? audioCtx.suspend() : audioCtx.resume();
            };
        }
        const useBackupControl = () => {
            window.backupControl = true;
            player.style.display = "none";
            document.getElementById("backupControls").style.display = "flex";
            player.addEventListener("play", () => {
                document.getElementById('playBtn').className = 'topBtn active';
            });
            player.addEventListener("pause", () => {
                document.getElementById('playBtn').className = 'topBtn';
            });
        }
        const menuList = document.getElementById("menuList");
        if (localStorage.fullBlur && JSON.parse(localStorage.fullBlur)) {
            document.getElementById("floatMenuContainer").style.backdropFilter = "blur(3px) brightness(100%)";
        }
        const showMenu = async () => {
            document.getElementById("floatMenuContainer").style.display = "block";
            await sleep(1);
            document.getElementById("floatMenuContainer").style.opacity = 1;
        };
        const hideMenu = async () => {
            document.getElementById("floatMenuContainer").style.opacity = 0;
            await sleep(200);
            document.getElementById("floatMenuContainer").style.display = "none";
        };
        document.getElementById("floatMenuContainer").addEventListener("click", (event) => {
            event.stopPropagation();
            hideMenu();
        })
        const setStatus = (text, loading) => {
            document.getElementById("loading").style.display = loading ? "block" : "none";
            document.getElementById("tips").innerText = text;
        };
        let player = document.getElementById("player");
        (async () => {
            if (window.codecBoost && window.wasmPlayer) {
                alert("播放器初始化失败！\n请勿同时启用Codec Boost和WASM播放器！");
                bottomdown();
                document.location.href = './settings';
                return;
            }
            if (window.wasmPlayer) {
                setStatus("加载WASM播放器");
                await loadScriptAsync("./lib/ogvjs/ogv.js");
                document.getElementById("playPanel").removeChild(player);
                player = new ogvjs.OGVPlayer();
                player.controls = true;
                player.autoplay = true;
                player.id = "player";
                player.style = "width: 100%;height:32px;";
                document.getElementById("playPanel").appendChild(player);
                useBackupControl();
                patchEnd();
                return;
            };
            if (window.codecBoost) {
                useBackupControl();
                return;
            };
        })();
        //初始化媒体控制
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', function () {
                if (window.backupControl) {
                    switchPlay();
                } else {
                    player.play();
                }
            });
            navigator.mediaSession.setActionHandler('pause', function () {
                if (window.backupControl) {
                    switchPlay();
                } else {
                    player.pause();
                }
            });
            navigator.mediaSession.setActionHandler('nexttrack', function () {
                playNext();
            });
        }
        const makeItem = (name, info, avatar, menuCallback) => {
            let newItem = document.createElement("li");
            newItem.className = "mdc-list-item";
            let rippleSpan = document.createElement("span");
            rippleSpan.className = "mdc-list-item__ripple";
            newItem.appendChild(rippleSpan);
            let avatarSpan = document.createElement("span");
            avatarSpan.className = "mdc-list-item__graphic";
            let imgItem = document.createElement("img");
            if (avatar.indexOf(".hdslb.") > 0) {
                avatar = avatar.replace("@.webp", "@120h.webp")
            };
            imgItem.src = avatar;
            imgItem.loading = "lazy";
            imgItem.alt = name;
            imgItem.style = "object-fit: cover;border-radius: 4px;height: 100%;width: 100%;opacity:0;transition: opacity 0.5s;";
            imgItem.onload = () => {
                imgItem.style.opacity = 1;
            }
            avatarSpan.appendChild(imgItem);
            newItem.appendChild(avatarSpan);
            let textSpan = document.createElement("span");
            textSpan.className = "mdc-list-item__text";
            let nameSpan = document.createElement("span");
            nameSpan.className = "mdc-list-item__primary-text";
            nameSpan.innerText = name;
            textSpan.appendChild(nameSpan);
            let infoSpan = document.createElement("span");
            infoSpan.className = "mdc-list-item__secondary-text";
            infoSpan.innerText = info;
            textSpan.appendChild(infoSpan);
            newItem.appendChild(textSpan);
            if (menuCallback) {
                let menu = document.createElement("span");
                menu.className = "mdc-list-item__meta";
                let menuBtn = document.createElement("button");
                menuBtn.innerText = "more_vert"
                menuBtn.addEventListener("click", menuCallback);
                menuBtn.className = "mdc-icon-button material-icons";
                menu.appendChild(menuBtn);
                newItem.appendChild(menu);
            }
            return newItem;
        }
        const makeMenu = (text, icon) => {
            let menuItem = document.createElement("li");
            menuItem.className = "mdc-list-item";
            let ripple = document.createElement("span");
            ripple.className == "mdc-list-item__ripple";
            menuItem.appendChild(ripple);
            if (icon) {
                let iconItem = document.createElement("img");
                iconItem.src = icon;
                iconItem.className = "mdc-list-item__graphic material-icons";
                menuItem.appendChild(iconItem);
            }
            let textItem = document.createElement("span");
            textItem.className = "mdc-list-item__text";
            textItem.innerText = text;
            menuItem.appendChild(textItem);
            return menuItem;
        }
        const saveImgMenu = url => {
            menuList.innerHTML = "";
            let imgItem = document.createElement("img");
            imgItem.src = url;
            imgItem.style = "max-height:calc(80vh - 32px);width:100%;height:auto;object-fit:cover;border-radius: 5px 5px 0px 0px;";
            menuList.appendChild(imgItem);
            let textTip = document.createElement("p");
            textTip.innerText = "长按或右键图片保存";
            textTip.style = "width:100%;text-align:center;"
            menuList.appendChild(textTip);
            showMenu();
        }
        const loadMenu = text => {
            let loadDiv = document.createElement("div");
            loadDiv.style = "display:flex;flex-direction:row;text-align:center;width:100%;justify-content: space-around;";
            let loadSvg = document.createElement("img");
            loadSvg.src = "./img/loading.svg";
            loadSvg.style = "width:32px;height:32px;padding:4px;";
            loadDiv.appendChild(loadSvg);
            let loadText = document.createElement("p");
            loadText.className = "tips32";
            loadText.innerText = text;
            loadDiv.appendChild(loadText);
            loadDiv.setText = text => {
                loadText.innerText = text;
            }
            return loadDiv;
        }
        const makeSongMenu = songInfo => {
            let dlMenu = makeMenu("下载", "./img/download.svg");
            dlMenu.addEventListener("click", async () => {
                setStatus("正在下载" + songInfo.name, true);
                let playBlob = URL.createObjectURL(await (await fetch(songInfo.url[cdn])).blob());
                dlFile(playBlob, songInfo.name + ".ogg");
                setStatus("下载" + songInfo.name + "成功", false);
            });
            menuList.appendChild(dlMenu);
            let coverMenu = makeMenu("保存封面", "./img/cover.svg");
            coverMenu.addEventListener("click", (event) => {
                event.stopPropagation();
                saveImgMenu(songInfo.cover);
            });
            menuList.appendChild(coverMenu)
            let goMenu = makeMenu("查看原始投稿", "./img/link.svg");
            goMenu.addEventListener("click", () => {
                window.open(songInfo.origin, "_blank")
            });
            menuList.appendChild(goMenu);
            let shareMenu = makeMenu("分享", "./img/share.svg");
            shareMenu.addEventListener("click", () => {
                shareSong(songInfo);
            });
            menuList.appendChild(shareMenu);
            let qualityMenu = makeMenu("播放音质:" + songInfo.quality + "/原始音质:" + songInfo.source_quality, "./img/audiofile.svg");
            menuList.appendChild(qualityMenu);
            let timeMenu = makeMenu("发布时间:" + songInfo.release_date, "./img/calendar.svg");
            menuList.appendChild(timeMenu);
            const list = new MDCList(menuList);
            const listItemRipples = list.listElements.map((listItemEl) => new MDCRipple(listItemEl));
        }
        const shareSong = async songInfo => {
            if (navigator.share) {
                if (window.fileShare) {
                    navigator.share({
                        title: songInfo.name,
                        text: "我正在用545在线(545.qinlili.bid)分享给你塔宝的" + songInfo.name,
                        url: "https://545.qinlili.bid",
                        files: [new File([await (await fetch(songInfo.url[cdn])).blob()], songInfo.name + ".ogg", { type: "audio/ogg" })]
                    });
                } else {
                    navigator.share({
                        title: "545在线",
                        text: "我正在用545在线(545.qinlili.bid)收听塔宝的" + songInfo.name + "，你可以点击此链接直接在线播放" + songInfo.url[cdn] + " 或使用545在线更方便的省流量播放",
                        url: "https://545.qinlili.bid"
                    });
                }
            } else {
                alert("你使用的浏览器不支持分享");
            }
        }
        document.title = "读取歌单...";
        const renderAudioList = async (force, update) => {
            const getAudioList = async () => {
                let jsonData = await (await fetch("audioInfo.json?ForceNoCache=1")).json()
                if (jsonData && jsonData.success) {
                    return jsonData.songs;
                }
                return false;
            }
            let audioList;
            if (localStorage.cacheSong && !force && update) {
                audioList = JSON.parse(localStorage.cacheSong);
                //异步更新歌单
                getAudioList().then(songs => {
                    if (songs) {
                        localStorage.cacheSong = JSON.stringify(songs);
                        window.audioList = songs;
                    }
                })
            } else {
                audioList = await getAudioList();
                if (audioList) {
                    localStorage.cacheSong = JSON.stringify(audioList);
                } else {
                    alert("读取歌单失败！请尝试刷新页面重试！");
                }
            }
            setStatus("就绪", false)
            document.title = "545在线-播放";
            console.log(audioList);
            window.audioList = audioList;
            //渲染全部歌单
            const audioFolderModule = document.getElementById("audioFolderModule");
            audioFolderModule.style.display = "none";
            audioFolderModule.innerHTML = "";
            let searchItem = makeItem("搜索", "本地歌单搜索，搜不到请设置内更新歌单", "./img/search.svg");
            searchItem.addEventListener("click", () => {
                let searchValue = prompt("请输入关键字，支持歌名/完整标题\n留空为显示全部歌曲");
                if (searchValue == null) {
                    return;
                }
                if (searchValue == "奥利安费") {
                    //开启隐藏终端模式
                    let terminalItem = makeItem("韭菜盒子", "运行一些能补充营养的指令", "./img/terminal.svg");
                    audioFolderModule.insertBefore(terminalItem, searchItem);
                    terminalItem.addEventListener("click", async () => {
                        //处理终端命令
                        let command = prompt("太监传话");
                        if (command == null) {
                            return;
                        }
                        switch (command) {
                            case "addSong": {
                                let songInfo = prompt("输入符合格式的歌曲信息");
                                try {
                                    addToPlayList(JSON.parse(songInfo));
                                } catch {
                                    alert("解析失败");
                                }
                                break;
                            };
                            case "emptyList": {
                                localStorage.removeItem("playList");
                                location.reload();
                                break;
                            };
                            case "connectDevice": {
                                const device = await navigator.usb.requestDevice({ filters: [] });
                                if (device) {
                                    await device.open();
                                    alert("连接外置声卡成功！\n制造厂商：" + device.manufacturerName + "\n设备型号：" + device.productName);
                                    await device.close();
                                } else {
                                    alert("连接到外置声卡失败！");
                                }
                                break;
                            }
                            default: {
                                alert("营养缺失了")
                                break;
                            }
                        }

                    })
                    return;
                }
                const audioFilesModule = document.getElementById("audioFilesModule");
                audioFilesModule.innerHTML = "";
                audioFolderModule.style.display = "none";
                let backItem = makeItem("...", "返回歌单列表", "./img/folder.svg")
                audioFilesModule.appendChild(backItem);
                backItem.addEventListener("click", () => {
                    audioFolderModule.style.display = "block";
                    audioFilesModule.style.display = "none";
                })
                //逐一匹配
                audioList.forEach(folderInfo => {
                    folderInfo.list.forEach(songInfo => {
                        if ((songInfo.name.indexOf(searchValue) >= 0) || (songInfo.full_title.indexOf(searchValue) >= 0)) {
                            let song = makeItem(songInfo.name, songInfo.full_title, songInfo.cover, (event) => {
                                //歌曲菜单
                                event.stopPropagation();
                                menuList.innerHTML = "";
                                makeSongMenu(songInfo);
                                showMenu();
                            });
                            song.addEventListener("click", () => {
                                addToPlayList(songInfo);
                            })
                            audioFilesModule.appendChild(song);
                        }
                    })
                })
                const list = new MDCList(audioFilesModule);
                const listItemRipples = list.listElements.map((listItemEl) => new MDCRipple(listItemEl));
                audioFilesModule.style.display = "block";
            });
            audioFolderModule.appendChild(searchItem);
            audioList.forEach(folderInfo => {
                //分类渲染
                let folder = makeItem(folderInfo.type, folderInfo.description, "./img/folder.svg", (event) => {
                    //文件夹菜单
                    event.stopPropagation();
                    menuList.innerHTML = "";
                    let addMenu = makeMenu("全部添加到播放列表", "./img/addlist.svg");
                    addMenu.addEventListener("click", () => {
                        folderInfo.list.forEach(addToPlayList);
                    });
                    menuList.appendChild(addMenu);
                    const list = new MDCList(menuList);
                    const listItemRipples = list.listElements.map((listItemEl) => new MDCRipple(listItemEl));
                    showMenu();
                });
                audioFolderModule.appendChild(folder);
                folder.addEventListener("click", () => {
                    //展开文件夹
                    const audioFilesModule = document.getElementById("audioFilesModule");
                    audioFilesModule.innerHTML = "";
                    audioFolderModule.style.display = "none";
                    let backItem = makeItem("...", "返回上一级目录", "./img/folder.svg")
                    audioFilesModule.appendChild(backItem);
                    backItem.addEventListener("click", () => {
                        audioFolderModule.style.display = "block";
                        audioFilesModule.style.display = "none";
                    })
                    //渲染子项目
                    folderInfo.list.forEach(songInfo => {
                        let song = makeItem(songInfo.name, songInfo.full_title, songInfo.cover, (event) => {
                            //歌曲菜单
                            event.stopPropagation();
                            menuList.innerHTML = "";
                            makeSongMenu(songInfo);
                            showMenu();
                        });
                        song.addEventListener("click", () => {
                            addToPlayList(songInfo);
                        })
                        audioFilesModule.appendChild(song);
                    })
                    audioFilesModule.style.display = "block";
                })
            })
            const list = new MDCList(audioFolderModule);
            const listItemRipples = list.listElements.map((listItemEl) => new MDCRipple(listItemEl));
            audioFolderModule.style.display = "block";
        }
        const renderPlayList = () => {
            const empty = () => {
                audioListModule.innerHTML = "";
                document.getElementById("empty").style.display = "block";
            }
            if (localStorage.playList) {
                if (JSON.parse(localStorage.playList).length) {
                    //渲染播放列表
                    document.getElementById("empty").style.display = "none";
                    window.list = JSON.parse(localStorage.playList);
                    const audioListModule = document.getElementById("audioListModule");
                    audioListModule.style.display = "none";
                    audioListModule.innerHTML = "";
                    window.list.forEach(songInfo => {
                        let song = makeItem(songInfo.name, songInfo.full_title, songInfo.cover, (event) => {
                            //歌曲菜单
                            event.stopPropagation();
                            menuList.innerHTML = "";
                            let deleteMenu = makeMenu("从播放列表里删除", "./img/delete.svg");
                            deleteMenu.addEventListener("click", async () => {
                                if (confirm("你想要从播放列表删除 " + songInfo.name + " 吗？")) {
                                    removeFromPlayList(songInfo);
                                }
                            });
                            menuList.appendChild(deleteMenu);
                            makeSongMenu(songInfo);
                            showMenu();
                        });
                        song.addEventListener("click", () => {
                            //立即播放
                            playNow(songInfo);
                        })
                        audioListModule.appendChild(song);
                    })
                    const list = new MDCList(audioListModule);
                    const listItemRipples = list.listElements.map((listItemEl) => new MDCRipple(listItemEl));
                    audioListModule.style.display = "block";
                } else {
                    empty();
                }
            } else {
                empty();
            }
        }
        const addToPlayList = song => {
            setStatus("已添加到播放列表:" + song.name, false);
            if (!window.list) {
                window.list = [];
            }
            window.list.push(song);
            window.list = window.list.filter((value, index, self) =>
                index === self.findIndex((t) => (
                    t.place === value.place && t.name === value.name
                ))
            )
            localStorage.playList = JSON.stringify(window.list);
            renderPlayList();
        }
        const removeFromPlayList = song => {
            setStatus("已移除播放列表:" + song.name, false);
            window.list.forEach((info, index) => {
                if (info == song) {
                    window.list.splice(index, 1)
                }
            });
            localStorage.playList = JSON.stringify(window.list);
            renderPlayList();
        }
        const playNow = async song => {
            document.title = song.name + "-545在线";
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.name,
                    artist: "帅比笙歌超可爱OvO",
                    album: "545在线",
                    artwork: [{
                        sizes: "320x180",// <- MUST BE EXACTLY!
                        src: song.cover,
                        type: ""
                    }]
                });
            }
            setStatus("正在下载" + song.name, true);
            window.currentPlay = song.name;
            let playBlob = await (await fetch(song.url[cdn]).catch(error => {
                setStatus("下载失败" + song.name, false);
                if (!navigator.onLine) {
                    //断网跳过未下载歌曲
                    player.dispatchEvent(new CustomEvent("ended"));
                } else {
                    playNow(song);
                }
            })).blob();
            if (window.currentPlay == song.name) {
                if (window.codecBoost) {
                    setStatus("解码音频中", true);
                    if (!window.audioCtx) {
                        window.audioCtx = new AudioContext();
                    }
                    let decodeBuffer = await window.audioCtx.decodeAudioData(await playBlob.arrayBuffer());
                    let source = audioCtx.createBufferSource();
                    if (window.currentSource) {
                        window.currentSource.disconnect(window.audioCtx.destination);
                    }
                    window.currentSource = source;
                    source.buffer = decodeBuffer;
                    source.connect(window.audioCtx.destination);
                    source.start(0);
                    document.getElementById("playBtn").className = (audioCtx.state == "running") ? "topBtn active" : "topBtn";
                    source.onended = () => {
                        player.dispatchEvent(new CustomEvent("ended"));
                    }
                    setStatus(song.name, false);
                    localStorage.lastPlay = JSON.stringify(song);
                } else {
                    player.src = URL.createObjectURL(playBlob);
                    player.play();
                    setStatus(song.name, false);
                    localStorage.lastPlay = JSON.stringify(song);
                }
            }
        }
        //恢复播放
        const recoverPlay = () => {
            if (localStorage.lastPlay) {
                let song = JSON.parse(localStorage.lastPlay)
                playNow(song);
            }
        }
        const playNext = () => {
            //随机播放下一首
            const getRandom = () => {
                let num;
                let randomMethod = localStorage.randomMethod || "default";
                switch (randomMethod) {
                    case "real": {
                        //crypto真随机
                        break;
                    };
                    case "list": {
                        //队列随机
                        if (window.order && window.order.length) {
                            num = window.order.pop();
                        } else {
                            //生成随机列表
                            let listLength = window.list.length;
                            let tempArray = []
                            let order = [];
                            for (let i = 0; i < listLength; i++) {
                                tempArray[i] = i;
                            };
                            for (let i = 0; i < listLength; i++) {
                                let pick = random(0, tempArray.length - 1)
                                order[i] = tempArray[pick];
                                tempArray.splice(pick, 1)
                            }
                            window.order = order;
                            console.log("生成了新的播放列表");
                            console.log(order);
                            num = window.order.pop();
                        }
                        break;
                    };
                    case "exclude": {
                        //就近排除
                        break;
                    };
                    case "default":
                    default: {
                        num = random(0, window.list.length - 1)
                        break;
                    }
                }
                return num;
            }
            playNow(window.list[getRandom()]);
        }
        const patchEnd = () => {
            player.addEventListener("ended", () => {
                if (repeatSwitch) {
                    player.play();
                    return;
                }
                if (shuffleSwitch) {
                    playNext();
                }
            })
        };
        const functionMenu = () => {
            menuList.innerHTML = "";
            //功能菜单
            let settingMenu = makeMenu("设置", "./img/setting.svg");
            settingMenu.addEventListener("click", () => {
                bottomdown();
                document.location.href = './settings';
            })
            menuList.appendChild(settingMenu);
            let toolMenu = makeMenu("工具箱", "./img/tool.svg");
            toolMenu.addEventListener("click", () => {
                bottomdown();
                document.location.href = './tools';
            })
            menuList.appendChild(toolMenu);
            if (history.length == 1) {
                let exitMenu = makeMenu("退出", "./img/exit.svg");
                exitMenu.addEventListener("click", () => {
                    window.close();
                })
                menuList.appendChild(exitMenu);
            }
            const list = new MDCList(menuList);
            const listItemRipples = list.listElements.map((listItemEl) => new MDCRipple(listItemEl));
            showMenu();
        }
        if (!navigator.serviceWorker) {
            alert("你的浏览器不支持Service Worker，你应该换个浏览器了");
        }
        if (navigator.userAgent.indexOf("WOW64") > 1) {
            alert("你正在64位操作系统上使用32位浏览器!为了更快的访问速度请改用64位浏览器!");
        }
        if (navigator.serviceWorker && !navigator.serviceWorker.controller) {
            const install = async () => {
                menuList.innerHTML = "";
                let tip = loadMenu("正在准备Service Worker...");
                menuList.appendChild(tip);
                showMenu();
                await (await fetch("./sw.js")).blob();
                tip.setText("读取版本信息...");
                let versionJson = await (await fetch("../version.json?ForceNoCache=1")).json();
                if (versionJson.success) {
                    tip.setText(`安装版本号：` + versionJson.latest);
                    await navigator.serviceWorker.register('./sw.js', { scope: '/' });
                    await sleep(3000)
                    tip.setText("安装完成，刷新后生效");
                    localStorage.triedInstall = true;
                    document.location.reload();
                } else {
                    if (confirm("读取版本失败！再试一次吗？")) {
                        install();
                    };
                }
            };
            if (!localStorage.triedInstall) {
                install()
            } else {
                if (confirm("上次安装Service Worker失败了，再试一次吗？")) {
                    install();
                }
            }
        } else {
            //检测直播
            (async () => {
                if (localStorage.livePush && JSON.parse(localStorage.livePush)) {
                    if (Notification.permission == "default") {
                        await Notification.requestPermission();
                    };
                    setInterval(async () => {
                        let liveStatus = await (await fetch("https://biliapi.qinlili.bid/status?uid=15641218&ForceNoCache=1").catch(error => { })).json();
                        if (liveStatus.data && (liveStatus.data.status == 1)) {
                            navigator.serviceWorker.ready.then(function (registration) {
                                registration.showNotification('塔宝正在直播！', {
                                    body: '赶紧去直播间补充塔能量吧',
                                    badge: './icon_mono.png',
                                    icon: './icon.png',
                                    tag: '直播推送'
                                });
                            });
                        }
                    }, 300000)
                } else {
                    showMenu();
                    menuList.innerHTML = "";
                    menuList.appendChild(loadMenu("正在检测塔宝直播状态..."));
                    let liveStatus = await (await fetch("https://biliapi.qinlili.bid/status?uid=15641218&ForceNoCache=1").catch(error => {
                        //检测失败
                        hideMenu();
                    })).json();
                    if (liveStatus.data && (liveStatus.data.status == 1) && confirm("塔宝正在直播，不去看直播？\n（点击确定即可快速打开直播间）")) {
                        window.open("https://live.bilibili.com/545", "_blank");
                    }
                    hideMenu();
                }
            })();
            if (!window.wasmPlayer && !window.codecBoost) {
                recoverPlay();
            }
        }
        patchEnd();
        renderAudioList(false, true);
        renderPlayList();
        (() => {
            if (localStorage.erudaEnabled && JSON.parse(localStorage.erudaEnabled)) {
                let script = document.createElement('script');
                script.src = "https://lib.baomitu.com/eruda/2.4.1/eruda.min.js";
                document.body.appendChild(script);
                script.onload = function () { eruda.init() }
            }
        })();
    </script>
</body>

</html>