<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link href="../public.css" rel="stylesheet">
    <link crossorigin="anonymous"
        integrity="sha512-tH5CEoO7QorGJK5RZrcKozo5xe0qC0UgOhjkIoqXNVe9ApFAjJRbVFzDfVvdRUSOJ5g2Pw9VzzOBguouzhLoIQ=="
        href="https://lib.baomitu.com/material-components-web/6.0.0/material-components-web.min.css" rel="stylesheet">
    <script crossorigin="anonymous"
        integrity="sha512-5zCl3JhN4Fqq6+irTX1v8J+77hwL54zTbrdl2Dl8YHe+KGcuV14C01u/uWFrSg+kZgOfGMneoUySVHqEgdRaPQ=="
        src="https://lib.baomitu.com/material-components-web/6.0.0/material-components-web.min.js"></script>
    <link crossorigin="anonymous"
        href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/material-design-icons/3.0.2/iconfont/material-icons.min.css"
        rel="stylesheet">
    <script src="../lib/base64.js"></script>
</head>

<body style="text-align: center">
    <H4 style="padding:16px;">提前全部缓存</H4>
    <button class="mdc-button mdc-button--raised mdc-button--leading" style="width:80%;margin:16px;" id="downBtn">
        <span class="mdc-button__ripple"></span>
        <i class="material-icons mdc-button__icon" aria-hidden="true">cloud_download</i>
        <span class="mdc-button__label" id="downBtnLabel">全部缓存</span>
    </button>
    <p id="cacheStatus"></p>
    <H4 style="padding:16px;">下方文本框内容即为你的播放列表信息</H4>
    <label class="mdc-text-field mdc-text-field--filled mdc-text-field--textarea mdc-text-field--no-label"
        style="padding:10px;height:auto;width:100%;">
        <span class="mdc-text-field__ripple"></span>
        <span class="mdc-text-field__resizer" style="width:100%;">
            <textarea class="mdc-text-field__input" rows="8" cols="40" aria-label="Label" id="playList"
                style="resize:none;"></textarea>
        </span>
        <span class="mdc-line-ripple"></span>
    </label>
    <br>
    <button class="mdc-button mdc-button--raised mdc-button--leading" style="width:80%;margin:16px;" id="saveBtn">
        <span class="mdc-button__ripple"></span>
        <i class="material-icons mdc-button__icon" aria-hidden="true">save</i>
        <span class="mdc-button__label">保存</span>
    </button>
    <script>
        window.mdc.autoInit();
        window.MDCTextField = mdc.textField.MDCTextField;
        window.MDCCheckbox = mdc.checkbox.MDCCheckbox;
        document.querySelectorAll('.mdc-button').forEach(element => {
            mdc.ripple.MDCRipple.attachTo(element);
        });
        document.querySelectorAll('.mdc-checkbox').forEach(element => {
            new MDCCheckbox(element);
        });
        const textField = new MDCTextField(document.querySelector('.mdc-text-field'));
        if (localStorage.playList) {
            document.getElementById("playList").value = Base64.encode(localStorage.playList);
        }
        document.getElementById("saveBtn").addEventListener("click", () => {
            let newPlayList;
            try {
                newPlayList = Base64.decode(document.getElementById("playList").value);
                console.log(JSON.parse(newPlayList));
                if (typeof JSON.parse(newPlayList) == "object") {
                    localStorage.playList = newPlayList;
                    window.parent.postMessage("close");
                } else {
                    alert("解析播放列表失败，请检查你的输入！");
                }
            } catch {
                alert("解析播放列表失败，请检查你的输入！");
            }
        });
        const cdn = "yuketang"
        document.getElementById("downBtn").addEventListener("click", () => {
            document.getElementById("downBtn").disabled = true;
            document.getElementById("downBtnLabel").innerText = "正在缓存...";
            const setStatus = (success, fail, total) => {
                document.getElementById("cacheStatus").innerText = "总计" + total + "首,已缓存" + success + "首,失败" + fail + "首";
                if ((success + fail) == total) {
                    document.getElementById("downBtn").disabled = false;
                    document.getElementById("downBtnLabel").innerText = "缓存完成";
                }
            }
            let playList = JSON.parse(localStorage.playList);
            let success = 0;
            let fail = 0;
            let total = playList.length;
            const addFail = () => {
                fail++;
                setStatus(success, fail, total);
            }
            const addSuccess = () => {
                success++;
                setStatus(success, fail, total);
            }
            playList.forEach(async song => {
                await (await fetch(song.url[cdn]).catch(error => {
                    addFail();
                })).blob().catch(error => {
                    addFail();
                })
                addSuccess();
            })
        })
    </script>
</body>

</html>