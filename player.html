<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>545在线-播放</title>
    <meta name="description" content="545在线，随时补充塔能量！笙歌牌播放器，支持智能缓存本地播放，由琴梨梨驱动" />
    <meta name="robots" content="noindex">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <link rel="canonical" href="https://545.qinlili.bid/player.html" />
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#9EA6E5">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="icon" href="./icon.png">
    <meta name="referrer" content="no-referrer" />
    <link rel="preconnect" href="https://i0.hdslb.com">
    <link rel="preconnect" href="https://bj.bcebos.com">
    <style>
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-panel {
            background-color: rgba(256, 256, 256, 1.0);
            border-radius: 0px;
        }

        ::-webkit-scrollbar {
            height: 12px;
            width: 8px;
            background: transparent;
            z-index: 12;
            overflow: visible;
        }

        ::-webkit-scrollbar-thumb {
            width: 10px;
            background-color: #DFAEFF;
            z-index: 12;
            border: 3px solid rgba(0, 0, 0, 0);
            background-clip: padding-box;
            transition: background-color .32s ease-in-out;
            margin: 4px;
            min-height: 32px;
            min-width: 32px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #DFAEFF;
        }

        ::-webkit-scrollbar-corner {
            background: #202020;
        }

        *:focus {
            outline: none;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-user-select: none;
            user-select: none;
        }

        html,
        body {
            width: 100%;
            height: 100%;
        }

        #playPanel {
            z-index: 999;
            position: fixed;
            height: auto;
            min-height: 32px;
            width: auto;
            left: 0px;
            right: 0px;
            bottom: 0px;
            padding: 2px;
            background-color: white;
            box-shadow: 0px -2px 2px 1px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        #audioList,
        #playList {
            text-align: left;
            overflow-y: scroll;
            height: calc(100vh - 112px);
            margin-bottom: 64px;
        }

        #tabBar {
            z-index: 999;
            position: fixed;
            height: auto;
            width: auto;
            left: 0px;
            right: 0px;
            top: 0px;
        }

        #empty {
            display: none;
            margin: auto;
            padding-top: 32px;
            height: auto;
            text-align: center;
        }

        #controls {
            justify-content: space-between;
            display: flex;
            flex-direction: row;
        }

        #status {
            display: flex;
            flex-direction: row;
            height: 32px;
            padding-left: 4px;
        }

        #tips {
            margin: auto;
            font-size: 1.1em;
        }

        #loading {
            margin: 4px;
        }

        #buttons {
            display: flex;
            flex-direction: row;
        }

        .topBtn {
            border-radius: 2px;
            height: auto;
            margin: 4px;
            width: auto;
            transition: background-color 0.2s, transform 0.3s ease-in-out;
        }

        .topBtn:hover {
            transform: scale(1.1, 1.1);
            background-color: #cccccc;
        }

        .topBtn:active {
            background-color: #999999
        }

        @media (min-width: 700px) {
            #listContainer {
                display: flex !important;
                flex-direction: row-reverse !important;
            }

            #audioList,
            #playList {
                display: block !important;
                width: 50vw;
            }
        }
    </style>
    <script>
        document.title = "载入播放器中..."
    </script>
    <link crossorigin="anonymous"
        integrity="sha512-tH5CEoO7QorGJK5RZrcKozo5xe0qC0UgOhjkIoqXNVe9ApFAjJRbVFzDfVvdRUSOJ5g2Pw9VzzOBguouzhLoIQ=="
        href="https://lib.baomitu.com/material-components-web/6.0.0/material-components-web.min.css" rel="stylesheet">
    <script crossorigin="anonymous"
        integrity="sha512-5zCl3JhN4Fqq6+irTX1v8J+77hwL54zTbrdl2Dl8YHe+KGcuV14C01u/uWFrSg+kZgOfGMneoUySVHqEgdRaPQ=="
        src="https://lib.baomitu.com/material-components-web/6.0.0/material-components-web.min.js"></script>
    <link crossorigin="anonymous"
        integrity="sha512-y9glprRcVESvYY3suAqBUYXx0ySbQNvbzzgvLy9F2o38Y7XCNeq/No2gnHjV3+Rjyq5ijoPZRMXotpdw6jcG4g=="
        href="https://lib.baomitu.com/material-design-icons/3.0.2/iconfont/material-icons.min.css" rel="stylesheet">
    <script src="./lib/pullrefresh.js"></script>
    <script src="./lib/long-press.min.js"></script>
</head>

<body style="text-align: center">
    <div class="mdc-tab-bar" id="tabBar" role="tablist">
        <div class="mdc-tab-scroller">
            <div class="mdc-tab-scroller__scroll-area">
                <div class="mdc-tab-scroller__scroll-content">
                    <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0"
                        onclick="switchPlaylist();">
                        <span class="mdc-tab__content">
                            <span class="mdc-tab__text-label">播放列表</span>
                        </span>
                        <span class="mdc-tab-indicator mdc-tab-indicator--active">
                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                        </span>
                        <span class="mdc-tab__ripple"></span>
                    </button>
                    <button class="mdc-tab mdc-tab" role="tab" aria-selected="false" tabindex="1"
                        onclick="switchAudioList();">
                        <span class="mdc-tab__content">
                            <span class="mdc-tab__text-label">全部歌单</span>
                        </span>
                        <span class="mdc-tab-indicator mdc-tab-indicator">
                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                        </span>
                        <span class="mdc-tab__ripple"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="playPanel">
        <div id="controls">
            <div id="status">
                <img src="./img/loading.svg" id="loading">
                <p id="tips">正在加载播放器</p>
            </div>
            <div id="buttons">
                <img class="topBtn" id="randomBtn" src="./img/shuffle.svg">
                <img class="topBtn" id="repeatBtn" src="./img/repeat.svg">
                <img class="topBtn" id="settingBtn" onclick="document.location.href='./settings.html'"
                    src="./img/setting.svg">
            </div>
        </div>
        <audio controls autoplay id="player" style="width: 100%;height:32px;"></audio>
    </div>
    <div style="height:48px;"></div>
    <div id="listContainer">
        <div id="audioList" style="display:none;">
            <ul id="audioFolderModule" class="mdc-list mdc-list--two-line mdc-list--avatar-list">
            </ul>
            <ul id="audioFilesModule" style="display:none;" class="mdc-list mdc-list--two-line mdc-list--avatar-list">
            </ul>
        </div>
        <div id="playList">
            <div id="empty">
                <img src="./img/bai.png">
                <H2>播放列表空了,所以摆了</H2>
                <H3>去全部歌单里添加一些吧</H3>
            </div>
            <ul id="audioListModule" class="mdc-list mdc-list--two-line mdc-list--avatar-list">
            </ul>
        </div>
    </div>
    <script>
        const sleep = delay => new Promise((resolve) => setTimeout(resolve, delay))
        window.MDCTabBar = mdc.tabBar.MDCTabBar;
        window.MDCList = mdc.list.MDCList;
        window.MDCRipple = mdc.ripple.MDCRipple;
        const tabBar = new MDCTabBar(document.querySelector('.mdc-tab-bar'));
        const audioList = document.getElementById("audioList");
        const playList = document.getElementById("playList");
        const switchAudioList = () => {
            audioList.style.display = "block"
            playList.style.display = "none"
        }
        const switchPlaylist = () => {
            audioList.style.display = "none"
            playList.style.display = "block"
        }
    </script>
    <script>
        const setStatus = (text, loading) => {
            document.getElementById("loading").style.display = loading ? "block" : "none";
            document.getElementById("tips").innerText = text;
        }
        const makeItem = (name, info, avatar, menuCallback) => {
            let newItem = document.createElement("li");
            newItem.className = "mdc-list-item";
            let rippleSpan = document.createElement("span");
            rippleSpan.className = "mdc-list-item__ripple";
            newItem.appendChild(rippleSpan);
            let avatarSpan = document.createElement("span");
            avatarSpan.className = "mdc-list-item__graphic";
            let imgItem = document.createElement("img");
            imgItem.src = avatar;
            imgItem.style.objectFit = "contain"
            imgItem.style.height = "100%";
            imgItem.style.width = "100%";
            avatarSpan.appendChild(imgItem);
            newItem.appendChild(avatarSpan);
            let textSpan = document.createElement("span");
            textSpan.className = "mdc-list-item__text";
            let nameSpan = document.createElement("span");
            nameSpan.className = "mdc-list-item__primary-text";
            nameSpan.innerText = name;
            textSpan.appendChild(nameSpan);
            let infoSpan = document.createElement("span");
            infoSpan.className = "mdc-list-item__secondary-text";
            infoSpan.innerText = info;
            textSpan.appendChild(infoSpan);
            newItem.appendChild(textSpan);
            if (menuCallback) {
                let menu = document.createElement("span");
                menu.className = "mdc-list-item__meta";
                let menuBtn = document.createElement("button");
                menuBtn.innerText = "more_vert"
                menuBtn.addEventListener("click", menuCallback);
                menuBtn.className = "mdc-icon-button material-icons";
                menu.appendChild(menuBtn);
                newItem.appendChild(menu);
            }
            return newItem;
        }
        document.title = "读取歌单...";
        const renderAudioList = async force => {
            const getAudioList = async () => {
                let jsonData = await (await fetch("audioInfo.json?ForceNoCache=1")).json()
                if (jsonData && jsonData.success) {
                    return jsonData.songs;
                }
                return false;
            }
            let audioList;
            if (localStorage.cacheSong && !force) {
                audioList = JSON.parse(localStorage.cacheSong)
            } else {
                audioList = await getAudioList();
                if (audioList) {
                    localStorage.cacheSong = JSON.stringify(audioList);
                } else {
                    alert("读取歌单失败！请尝试刷新页面重试！")
                }
            }
            setStatus("就绪", false)
            document.title = "545在线-播放";
            console.log(audioList);
            window.audioList = audioList;
            //渲染全部歌单
            const audioFolderModule = document.getElementById("audioFolderModule");
            audioFolderModule.innerHTML = "";
            audioList.forEach(folderInfo => {
                //分类渲染
                let folder = makeItem(folderInfo.type, folderInfo.description, "./img/folder.svg", (event) => {
                    //文件夹菜单
                    event.stopPropagation();
                    console.log(this)
                    console.log(event)
                });
                audioFolderModule.appendChild(folder);
                folder.addEventListener("click", () => {
                    //展开文件夹
                    const audioFilesModule = document.getElementById("audioFilesModule");
                    audioFilesModule.innerHTML = "";
                    audioFolderModule.style.display = "none";
                    audioFilesModule.style.display = "block";
                    let backItem = makeItem("...", "返回上一级目录", "./img/folder.svg")
                    audioFilesModule.appendChild(backItem);
                    backItem.addEventListener("click", () => {
                        audioFolderModule.style.display = "block";
                        audioFilesModule.style.display = "none";
                    })
                    //渲染子项目
                    folderInfo.list.forEach(songInfo => {
                        let song = makeItem(songInfo.name, songInfo.full_title, songInfo.cover, (event) => {
                            //歌曲菜单
                            event.stopPropagation();
                        });
                        song.addEventListener("click", () => {
                            addToPlayList(songInfo);
                        })
                        audioFilesModule.appendChild(song);
                    })
                })
            })
            const list = new MDCList(audioFolderModule);
            const listItemRipples = list.listElements.map((listItemEl) => new MDCRipple(listItemEl));
        }
        renderAudioList(false);
        PullToRefresh.init({
            mainElement: '#audioList',
            onRefresh: function () {
                renderAudioList(true);
            }
        });
        const renderPlayList = () => {
            const empty = () => {
                document.getElementById("empty").style.display = "block";
            }
            if (localStorage.playList) {
                if (JSON.parse(localStorage.playList).length) {
                    //渲染播放列表
                    document.getElementById("empty").style.display = "none";
                    window.list = JSON.parse(localStorage.playList);
                    const audioListModule = document.getElementById("audioListModule");
                    audioListModule.innerHTML = "";
                    window.list.forEach(songInfo => {
                        let song = makeItem(songInfo.name, songInfo.full_title, songInfo.cover, (event) => {
                            //歌曲菜单
                            event.stopPropagation();
                        });
                        song.addEventListener("click", () => {
                            //立即播放
                            playNow(songInfo);
                        })
                        song.addEventListener('long-press', () => {
                            if (confirm("你想要从播放列表删除 " + songInfo.name + " 吗？")) {
                                removeFromPlayList(songInfo);
                            }
                        })
                        audioListModule.appendChild(song);
                    })
                } else {
                    empty();
                }
            } else {
                empty();
            }
        }
        renderPlayList();
        const addToPlayList = song => {
            if (!window.list) {
                window.list = [];
            }
            window.list.push(song);
            window.list = window.list.filter((value, index, self) =>
                index === self.findIndex((t) => (
                    t.place === value.place && t.name === value.name
                ))
            )
            localStorage.playList = JSON.stringify(window.list);
            renderPlayList();
        }
        const removeFromPlayList = song => {
            window.list.forEach((info, index) => {
                if (info == song) {
                    window.list.splice(index, 1)
                }
            });
            localStorage.playList = JSON.stringify(window.list);
            renderPlayList();
        }
        const playNow = async song => {
            //为日后多CDN切换做准备
            const cdn = "yuketang";
            document.title = song.name + "-545在线";
            setStatus("正在下载" + song.name, true);
            let playBlob = URL.createObjectURL(await (await fetch(song.url[cdn])).blob())
            document.getElementById("player").src = playBlob;
            setStatus(song.name, false);
            localStorage.lastPlay = JSON.stringify(song);
        }
        const recoverPlay = async () => {
            if (localStorage.lastPlay) {
                let song = JSON.parse(localStorage.lastPlay)
                const cdn = "yuketang";
                document.title = song.name + "-545在线";
                setStatus("正在下载" + song.name, true);
                let playBlob = URL.createObjectURL(await (await fetch(song.url[cdn])).blob())
                document.getElementById("player").src = playBlob;
                setStatus(song.name, false);
            }
        }
        recoverPlay();
    </script>
</body>

</html>